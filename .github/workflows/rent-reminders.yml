name: Automated Rent Reminders

on:
  schedule:
    # Run daily at 8:00 AM WAT (7:00 AM UTC)
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  send-rent-reminders:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Rent Reminders
      run: |
        curl -X POST "${{ secrets.APP_URL }}/api/check-rent-reminders" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          -H "Content-Type: application/json" \
          -w "HTTP Status: %{http_code}\n" \
          -o response.json
        
        # Display the response
        echo "Response:"
        cat response.json
        
        # Check if the request was successful
        if [ $(curl -X POST "${{ secrets.APP_URL }}/api/check-rent-reminders" \
             -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
             -H "Content-Type: application/json" \
             -w "%{http_code}" -o /dev/null -s) -ne 200 ]; then
          echo "Failed to send rent reminders"
          exit 1
        else
          echo "Rent reminders sent successfully"
        fi

    - name: Log Results
      if: always()
      run: |
        echo "Rent reminder job completed at $(date)"
        echo "Next scheduled run: $(date -d 'tomorrow 8:00' '+%Y-%m-%d %H:%M:%S WAT')"